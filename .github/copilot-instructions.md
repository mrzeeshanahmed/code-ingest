# Code Ingest – AI Guidance

- Activation wiring lives in `src/extension.ts`; register new capabilities through `CommandServices` (`src/commands/types.ts`) so `registerAllCommands` can inject shared services.
- The digest pipeline is centered on `DigestGenerator` (`src/services/digestGenerator.ts`), which chains `FileScanner` → `FilterService` → `ContentProcessor`/`NotebookProcessor` → `TokenAnalyzer` → formatters under `src/formatters`. Preserve progress callbacks and token budgeting when adding stages.
- File scanning honours `.gitignore` via `GitignoreService`; keep cancellability (`CancelToken` checks and `asyncPool` limits) and cap default workloads at 5k files / 16k tokens as enforced in `DigestGenerator`.
- Remote ingestion flows through `RemoteRepoService` (`src/services/remoteRepoService.ts`) and `WorkspaceManager`; always invoke git via `GitProcessManager` to inherit credential scrubbing and retries.
- Notebook ingestion is centralized in `NotebookProcessor`; respect cell filters and output truncation rules defined there before passing data downstream.
- Token accounting is handled by `TokenAnalyzer`; never bypass `enforceBudget` helpers when emitting summaries or table-of-contents data.
- Webview contracts use typed envelopes: host side in `src/providers/codeIngestPanel.ts` + `src/providers/messageEnvelope.ts`, client side in `resources/webview/messageEnvelope.js`. New host↔webview messages must be reflected in `src/commands/commandMap.ts` and regenerated via `npm run build:webview` (runs `scripts/copyWebviewResources.js`).
- Webview UI state is powered by `resources/webview/store.js` and handler modules under `resources/webview/handlers/`; each handler exports `validate` + `handle` and has matching tests under `resources/webview/handlers/__tests__/` enforced by `npm run check-handlers-coverage`.
- Digest outputs are formatted by `src/formatters/{markdown,json,text}Formatter.ts`; keep summaries small and rely on shared helpers from `templateEngine.ts` for consistent headings.
- Performance dashboards live in `resources/webview/performanceDashboard/` and rely on `PerformanceMonitor` (`src/services/performanceMonitor.ts`); keep metrics lightweight and scrub PII before logging.
- Respect redaction defaults in `src/utils/redactSecrets.ts`; pass `redactionOverride` flags explicitly and route sensitive output through `OutputWriter` (`src/services/outputWriter.ts`) which supports streaming writes and cancellation.
- Diagnostics, telemetry, and error reporting are centralized: use `ErrorReporter.report(err, context)` for surfaced failures, `TelemetryService` for metrics, and append user-facing warnings through `services/diagnosticService.ts`.
- Configuration comes from `ConfigurationService` (`src/services/configurationService.ts`) backed by defaults in `src/config/constants.ts`; reuse `validateConfig` helpers in `src/utils/validateConfig.ts` before trusting workspace settings.
- Cache warm-start logic lives in `src/services/cacheService.ts`; invalidate caches when touching scanner inputs or digest options.
- Generated assets land in `out/resources/webview`; activation auto-runs `scripts/copyWebviewResources.js` if bundles are missing, but CI expects you to pre-run `npm run build:webview`.
- Preferred coding style: TypeScript strict, 2-space indent, explicit return types on exported functions, avoid `any` (use `unknown` for external data) and wrap asynchronous errors with `wrapError` helpers in `src/utils/errorHandler.ts`.
- Unit tests live under `src/test` and `test/`; when adding modules provide at least three Jest cases (success, edge, failure) and use fixtures from `test/support`. Webview tests run with `npm run test:webview` (JSdom + Babel).
- Common developer commands: `npm run build` (webview copy + webpack), `npm run watch` (development bundle), `npm run lint`, `npm run type-check`, `npm run test:unit`, `npm run test:integration`, and `npm run ci` (full quality gate). Run `npm run build:webview` before packaging or when touching client assets.
- Use the "Code Ingest" VS Code output channel for telemetry/debug logs and "Code Ingest Errors" for surfaced issues; commands registered through `createCommandWrapper` automatically log timings and show recovery actions.
- Keep IPC payloads lean: avoid sending full file contents to the webview, favour previews and use `previewDelta` events for incremental updates as seen in existing handlers.
- When extending commands (e.g., `generateDigest`, `loadRemoteRepo`), wrap handlers with `createCommandWrapper` in `extension.ts` to ensure telemetry, logging, and error prompts remain consistent.
